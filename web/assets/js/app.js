class DiscordLoggerUI {
    constructor() {
        this.consoleEl = document.getElementById('console-output');
        this.webhookInput = document.getElementById('webhook-url');
        this.init();
    }

    init() {
        this.log("GUI initialized. Ready to connect.", "system");
        
        // auto load webhook from localstorage if exists
        const savedHook = localStorage.getItem('discord_webhook');
        if(savedHook) this.webhookInput.value = savedHook;
    }

    log(msg, type = "info") {
        const time = new Date().toLocaleTimeString();
        const div = document.createElement('div');
        div.className = `console__line ${type}`;
        div.innerHTML = `<span class="time">[${time}]</span> ${msg}`;
        this.consoleEl.appendChild(div);
        this.consoleEl.scrollTop = this.consoleEl.scrollHeight;
    }

    async sendToDiscord(payload) {
        const url = this.webhookInput.value.trim();
        
        if (!url.startsWith("https://discord")) {
            this.log("Error: Invalid or missing Webhook URL", "error");
            return;
        }

        // save for later
        localStorage.setItem('discord_webhook', url);

        this.log("Sending payload to Discord...", "info");

        try {
            const req = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (req.ok) {
                this.log("Success: Payload delivered.", "success");
            } else {
                this.log(`Failed: Status ${req.status}`, "error");
            }
        } catch (e) {
            this.log(`Network Error: ${e.message}`, "error");
        }
    }

    testConnection() {
        this.sendToDiscord({
            content: "ðŸ”Œ **Dashboard Connection Test**\nSystem is online and ready.",
            embeds: [{
                title: "Status: Online",
                color: 5763719,
                description: "Latency: 12ms"
            }]
        });
    }

    simulateCrash() {
        this.log("Initiating crash simulation...", "info");
        setTimeout(() => {
            this.sendToDiscord({
                content: "<@&999999999> ðŸš¨ **CRITICAL ERROR DETECTED**",
                embeds: [{
                    title: "RuntimeError: Division by zero",
                    description: "Traceback (most recent call last):\nFile \"core.py\", line 42, in module\nZeroDivisionError: division by zero",
                    color: 15548997,
                    footer: { text: "Generated by Web Dashboard" },
                    timestamp: new Date().toISOString()
                }]
            });
            this.log("Critical error report sent!", "error");
        }, 800);
    }

    sendCustom() {
        this.sendToDiscord({
            embeds: [{
                title: "Manual Log Entry",
                description: "This is a log triggered manually from the dashboard.",
                color: 3447003,
                fields: [
                    { name: "User", value: "Admin", inline: true },
                    { name: "Action", value: "Force Update", inline: true }
                ]
            }]
        });
    }
}

// start app
const logger = new DiscordLoggerUI();